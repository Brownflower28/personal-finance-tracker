<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker</title>
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-auth.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-firestore.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #4A90E2 0%, #7B68EE 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            flex-direction: column;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .save-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .save-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .year-selector {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 30px;
            text-align: center;
        }

        .year-tabs {
            display: inline-flex;
            gap: 8px;
        }

        .year-tab {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            color: #6c757d;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .year-tab.active {
            background: #4A90E2;
            color: white;
            border-color: #4A90E2;
        }

        .month-tabs-container {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 0 30px;
        }

        .month-tabs {
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .month-tab {
            padding: 15px 20px;
            border: none;
            background: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .month-tab:hover {
            color: #4A90E2;
        }

        .month-tab.active {
            color: #4A90E2;
            border-bottom-color: #4A90E2;
        }

        .category-tabs-container {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
            padding: 15px 30px;
        }

        .category-tabs {
            display: flex;
            justify-content: center;
            gap: 0;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 12px 20px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            border-radius: 25px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
        }

        .category-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .category-tab.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .category-tab[data-category="income"] {
            background: linear-gradient(135deg, #6da3f5 0%, #4A90E2 100%);
            color: white;
        }

        .category-tab[data-category="savings"] {
            background: linear-gradient(135deg, #52c96a 0%, #28a745 100%);
            color: white;
        }

        .category-tab[data-category="discretionary"] {
            background: linear-gradient(135deg, #ff9a47 0%, #fd7e14 100%);
            color: white;
        }

        .category-tab[data-category="investments"] {
            background: linear-gradient(135deg, #9768d9 0%, #6f42c1 100%);
            color: white;
        }

        .category-tab[data-category="expenses"] {
            background: linear-gradient(135deg, #f56565 0%, #dc3545 100%);
            color: white;
        }

        .category-tab-emoji {
            font-size: 18px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        .main-content {
            padding: 30px;
        }

        .category-section {
            margin-bottom: 40px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .category-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .category-icon.income {
            background: linear-gradient(135deg, #6da3f5 0%, #4A90E2 100%);
        }

        .category-icon.savings {
            background: linear-gradient(135deg, #52c96a 0%, #28a745 100%);
        }

        .category-icon.discretionary {
            background: linear-gradient(135deg, #ff9a47 0%, #fd7e14 100%);
        }

        .category-icon.investments {
            background: linear-gradient(135deg, #9768d9 0%, #6f42c1 100%);
        }

        .category-icon.expenses {
            background: linear-gradient(135deg, #f56565 0%, #dc3545 100%);
        }

        .category-info h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .category-info p {
            color: #6c757d;
            font-size: 14px;
            margin: 2px 0 0 0;
        }

        .line-items-header {
            display: grid;
            grid-template-columns: auto 2fr 1fr 1fr 1fr auto;
            gap: 20px;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 15px;
            font-size: 13px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .line-item {
            display: grid;
            grid-template-columns: auto 2fr 1fr 1fr 1fr auto;
            gap: 20px;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .line-item input, .line-item select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }

        .line-item input:focus, .line-item select:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .recurring-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #e7f3ff;
            color: #0066cc;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 16px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4A90E2;
            color: white;
            border-color: #4A90E2;
        }

        .btn-primary:hover {
            background: #357abd;
        }

        .btn-secondary {
            background: white;
            color: #6c757d;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
            padding: 6px 10px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .summary-section {
            margin: 40px 0;
        }

        .summary-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: left;
        }

        .summary-card h4 {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .summary-card .amount {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .summary-income { border-left: 4px solid #4A90E2; }
        .summary-expenses { border-left: 4px solid #dc3545; }
        .summary-discretionary { border-left: 4px solid #fd7e14; }
        .summary-investments { border-left: 4px solid #6f42c1; }
        .summary-savings { border-left: 4px solid #28a745; }

        .bottom-section {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 30px;
            margin-top: 40px;
        }

        .calendar-section, .chart-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .section-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            border-radius: 4px 4px 0 0;
            overflow: hidden;
            margin-bottom: 1px;
        }

        .calendar-day-header, .calendar-day {
            background: white;
            padding: 12px 8px;
            text-align: center;
            font-size: 12px;
            position: relative;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day-header {
            background: #f8f9fa;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.has-events {
            background: #e7f3ff;
        }

        .calendar-dots {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }

        .calendar-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .dot-income { background: #4A90E2; }
        .dot-expenses { background: #dc3545; }
        .dot-discretionary { background: #fd7e14; }
        .dot-investments { background: #6f42c1; }
        .dot-savings { background: #28a745; }

        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
            overflow: hidden;
        }

        .chart-container canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .insights-section {
            margin-top: 40px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
        }

        .insights-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .insight-item {
            padding: 12px 0;
            border-bottom: 1px solid #f8f9fa;
            color: #6c757d;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .copy-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .copy-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .month-checkboxes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .month-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            display: none;
            max-width: 200px;
        }

        /* Save status notification */
        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        .save-status.success {
            background-color: #28a745;
        }

        .save-status.error {
            background-color: #dc3545;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
            }
            
            .header, .main-content {
                padding: 20px;
            }
            
            .header-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .bottom-section {
                grid-template-columns: 1fr;
            }
            
            .line-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .line-items-header {
                display: none;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .month-tabs, .category-tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1><span id="currentYear">2025</span> Personal Finance Tracker</h1>
                <div class="user-info" id="userInfo" style="font-size: 14px; color: rgba(255,255,255,0.8); margin-top: 4px;">
                    Loading user...
                </div>
            </div>
            <div class="header-buttons">
                <button class="save-btn" onclick="manualSave()">
                    💾 Save Progress
                </button>
                <button class="save-btn" onclick="logOut()">
                    🚪 Log Out
                </button>
            </div>
        </div>

        <div class="year-selector">
            <div class="year-tabs">
                <button class="year-tab active" data-year="2025">2025</button>
                <button class="year-tab" data-year="2026">2026</button>
                <button class="year-tab" data-year="2027">2027</button>
                <button class="year-tab" data-year="2028">2028</button>
                <button class="year-tab" data-year="2029">2029</button>
                <button class="year-tab" data-year="2030">2030</button>
            </div>
        </div>

        <div class="month-tabs-container">
            <div class="month-tabs">
                <button class="month-tab active" data-month="0">January</button>
                <button class="month-tab" data-month="1">February</button>
                <button class="month-tab" data-month="2">March</button>
                <button class="month-tab" data-month="3">April</button>
                <button class="month-tab" data-month="4">May</button>
                <button class="month-tab" data-month="5">June</button>
                <button class="month-tab" data-month="6">July</button>
                <button class="month-tab" data-month="7">August</button>
                <button class="month-tab" data-month="8">September</button>
                <button class="month-tab" data-month="9">October</button>
                <button class="month-tab" data-month="10">November</button>
                <button class="month-tab" data-month="11">December</button>
            </div>
        </div>

        <div class="category-tabs-container">
            <div class="category-tabs">
                <button class="category-tab active" data-category="income">
                    <span class="category-tab-emoji">💰</span> Income
                </button>
                <button class="category-tab" data-category="savings">
                    <span class="category-tab-emoji">🏦</span> Savings
                </button>
                <button class="category-tab" data-category="discretionary">
                    <span class="category-tab-emoji">🛍️</span> Discretionary
                </button>
                <button class="category-tab" data-category="investments">
                    <span class="category-tab-emoji">📈</span> Investments
                </button>
                <button class="category-tab" data-category="expenses">
                    <span class="category-tab-emoji">🧾</span> Expenses
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="category-section">
                <div class="category-header">
                    <div class="category-icon income" id="categoryIcon">
                        💰
                    </div>
                    <div class="category-info">
                        <h3 id="categoryTitle">Income</h3>
                        <p id="categoryDescription">Track all sources of income including salary, side hustles, and other earnings.</p>
                    </div>
                </div>

                <div class="line-items-header">
                    <div>Select</div>
                    <div>Description</div>
                    <div>Amount (AUD)</div>
                    <div>Date</div>
                    <div>Frequency</div>
                    <div>Actions</div>
                </div>

                <div id="lineItemsContainer"></div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addLineItem()">
                        + Add <span id="categoryName">Income</span>
                    </button>
                    <button class="btn btn-secondary" onclick="showNewCopyModal()">
                        📋 Copy Items
                    </button>
                </div>
            </div>

            <div class="summary-section">
                <h3>Monthly Summary</h3>
                <div class="summary-cards">
                    <div class="summary-card summary-income">
                        <h4>Total Income</h4>
                        <div class="amount" id="totalIncome">$0.00</div>
                    </div>
                    <div class="summary-card summary-expenses">
                        <h4>Total Expenses</h4>
                        <div class="amount" id="totalExpenses">$0.00</div>
                    </div>
                    <div class="summary-card summary-discretionary">
                        <h4>Total Discretionary</h4>
                        <div class="amount" id="totalDiscretionary">$0.00</div>
                    </div>
                    <div class="summary-card summary-investments">
                        <h4>Total Investments</h4>
                        <div class="amount" id="totalInvestments">$0.00</div>
                    </div>
                    <div class="summary-card summary-savings">
                        <h4>Total Savings</h4>
                        <div class="amount" id="totalSavings">$0.00</div>
                    </div>
                </div>
            </div>

            <div class="bottom-section">
                <div class="calendar-section">
                    <div class="section-header">
                        <h3>Calendar View - <span id="calendarMonth">January</span> <span id="calendarYear">2025</span></h3>
                    </div>
                    <div class="calendar-header">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                    </div>
                    <div class="calendar-grid" id="calendar"></div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color dot-income"></div>
                            <span>Income</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color dot-savings"></div>
                            <span>Savings</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color dot-discretionary"></div>
                            <span>Discretionary</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color dot-investments"></div>
                            <span>Investments</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color dot-expenses"></div>
                            <span>Expenses</span>
                        </div>
                    </div>
                </div>

                <div class="chart-section">
                    <div class="section-header">
                        <h3>Budget Breakdown</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="insights-section">
                <h3>Financial Position</h3>
                <div id="insightsContent">
                    <div class="insight-item">
                        <strong>Financial Position</strong><br>
                        Add income and expenses to see your monthly financial position.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Modal -->
    <div class="copy-modal" id="copyModal">
        <div class="copy-modal-content">
            <div class="modal-header">
                <h3>Copy to Other Months</h3>
                <p>Select which months to copy the selected items to:</p>
            </div>
            <div class="month-checkboxes" id="monthCheckboxes"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCopyModal()">Cancel</button>
                <button class="btn btn-primary" onclick="executeNewCopy()">Copy Items (NEW)</button>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC2GUdDlY-pSGRzYHHIZOFSKOgK_HA8_9Q",
            authDomain: "personal-finance-tracker-7bf93.firebaseapp.com",
            projectId: "personal-finance-tracker-7bf93",
            storageBucket: "personal-finance-tracker-7bf93.firebasestorage.app",
            messagingSenderId: "442536820",
            appId: "1:442536820:web:1c930c446267d70eb39221",
            measurementId: "G-J4BY26858Q"
        };

        // Initialize Firebase (but don't use it yet)
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log('Firebase initialized successfully in tracker');

        // Data structure
        let financeData = {};
        let currentYear = 2025;
        let currentMonth = 0;
        let currentCategory = 'income';
        let pieChart = null;
        let saveTimeout; // For auto-save debouncing

        // Category configurations
        const categoryConfig = {
            income: {
                title: 'Income',
                description: 'Track all sources of income including salary, side hustles, and other earnings.',
                icon: 'fas fa-dollar-sign',
                emoji: '💰',
                color: '#4A90E2'
            },
            savings: {
                title: 'Savings',
                description: 'Track your savings contributions and emergency fund deposits.',
                icon: 'fas fa-piggy-bank',
                emoji: '🏦',
                color: '#28a745'
            },
            discretionary: {
                title: 'Discretionary',
                description: 'Track optional spending like entertainment, dining out, and hobbies.',
                icon: 'fas fa-shopping-bag',
                emoji: '🛍️',
                color: '#fd7e14'
            },
            investments: {
                title: 'Investments',
                description: 'Track investment contributions to shares, super, and other assets.',
                icon: 'fas fa-chart-line',
                emoji: '📈',
                color: '#6f42c1'
            },
            expenses: {
                title: 'Expenses',
                description: 'Track essential expenses like rent, utilities, groceries, and bills.',
                icon: 'fas fa-receipt',
                emoji: '🧾',
                color: '#dc3545'
            }
        };

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

        // === STEP 1: FIREBASE SAVE/LOAD FUNCTIONS ===
        
        // Save user's finance data to Firestore
        async function saveDataToFirebase() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    console.log('No user logged in');
                    return;
                }

                console.log('💾 Saving data to Firebase for user:', user.uid);
                
                // Save to Firestore using user's UID as document ID
                await db.collection('financeData').doc(user.uid).set({
                    data: financeData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('✅ Data saved successfully to Firebase');
                showSaveStatus('Data saved successfully!', 'success');
                
            } catch (error) {
                console.error('❌ Error saving data to Firebase:', error);
                showSaveStatus('Error saving data', 'error');
            }
        }

        // Load user's finance data from Firestore
        async function loadDataFromFirebase() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    console.log('No user logged in');
                    return;
                }

                console.log('📥 Loading data from Firebase for user:', user.uid);
                
                const doc = await db.collection('financeData').doc(user.uid).get();
                
                if (doc.exists) {
                    const userData = doc.data();
                    financeData = userData.data || {};
                    console.log('✅ Data loaded successfully from Firebase');
                    showSaveStatus('Data loaded successfully!', 'success');
                    
                    // Refresh the display with loaded data
                    updateDisplay();
                } else {
                    console.log('📝 No existing data found, starting fresh');
                    // Initialize empty data structure
                    initializeData();
                }
                
            } catch (error) {
                console.error('❌ Error loading data from Firebase:', error);
                showSaveStatus('Error loading data', 'error');
                // Initialize empty data if loading fails
                initializeData();
            }
        }

        // Auto-save function that debounces to avoid too many saves
        function autoSave() {
            // Clear previous timeout
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Set new timeout to save after 2 seconds of inactivity
            saveTimeout = setTimeout(() => {
                console.log('🔄 Auto-saving...');
                saveDataToFirebase();
            }, 2000);
        }

        // Manual save function for the save button
        function manualSave() {
            console.log('💾 Manual save button clicked');
            saveDataToFirebase();
        }

        // Show save status to user
        function showSaveStatus(message, type) {
            // Remove existing status if any
            const existingStatus = document.querySelector('.save-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `save-status ${type}`;
            statusDiv.textContent = message;
            
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.style.opacity = '0';
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.parentNode.removeChild(statusDiv);
                    }
                }, 300);
            }, 2000);
        }

        // Global function for logout button
        function logOut() {
            console.log('logOut function called - clearing Firebase auth...'); // Debug log
            
            // Sign out from Firebase first
            auth.signOut().then(() => {
                console.log('Firebase sign out successful');
                console.log('Redirecting to login page...');
                
                // Use relative path for local files
                window.location.href = './index.html';
            }).catch((error) => {
                console.log('Firebase sign out error:', error);
                // If Firebase signout fails, still redirect
                console.log('Redirecting anyway...');
                window.location.href = './index.html';
            });
        }

        // Global functions for copy modal
        function showCopyModal() {
            console.log('showCopyModal called'); // Debug log
            const selectedItems = financeData[currentYear][currentMonth][currentCategory].filter(item => item.selected);
            console.log('Selected items for copy:', selectedItems); // Debug log
            
            if (selectedItems.length === 0) {
                alert('Please select items to copy first by checking the boxes next to them.');
                return;
            }
            
            const modal = document.getElementById('copyModal');
            const checkboxContainer = document.getElementById('monthCheckboxes');
            
            checkboxContainer.innerHTML = monthNames.map((month, index) => 
                `<label class="month-checkbox">
                    <input type="checkbox" value="${index}"> ${month} ${currentYear}
                </label>`
            ).join('');
            
            modal.style.display = 'block';
        }

        function closeCopyModal() {
            console.log('closeCopyModal called'); // Debug log
            document.getElementById('copyModal').style.display = 'none';
        }

        // BRAND NEW COPY SYSTEM - COMPLETELY SEPARATE
        function showNewCopyModal() {
            console.log('NEW COPY MODAL SYSTEM ACTIVATED');
            
            const selectedItems = financeData[currentYear][currentMonth][currentCategory].filter(item => item.selected);
            console.log('Selected items for NEW copy:', selectedItems);
            
            if (selectedItems.length === 0) {
                alert('Please select items to copy first by checking the boxes next to them.');
                return;
            }
            
            const modal = document.getElementById('copyModal');
            const checkboxContainer = document.getElementById('monthCheckboxes');
            
            checkboxContainer.innerHTML = monthNames.map((month, index) => 
                `<label class="month-checkbox">
                    <input type="checkbox" value="${index}"> ${month} ${currentYear}
                </label>`
            ).join('');
            
            modal.style.display = 'block';
        }

        function executeNewCopy() {
            console.log('=== NEW COPY SYSTEM EXECUTING ===');
            
            const selectedItems = financeData[currentYear][currentMonth][currentCategory].filter(item => item.selected);
            const selectedMonths = Array.from(document.querySelectorAll('#monthCheckboxes input:checked')).map(cb => parseInt(cb.value));
            
            console.log('Items to copy:', selectedItems);
            console.log('Target months:', selectedMonths.map(m => monthNames[m]));
            
            if (selectedMonths.length === 0) {
                alert('Please select at least one month to copy to.');
                return;
            }
            
            selectedMonths.forEach(targetMonth => {
                selectedItems.forEach(item => {
                    const newItem = {
                        id: Date.now() + Math.random(),
                        description: item.description,
                        amount: item.amount,
                        date: '', // ALWAYS EMPTY - user must select date
                        frequency: item.frequency,
                        selected: false
                    };
                    
                    console.log(`NEW SYSTEM: Copying "${item.description}" with EMPTY date to ${monthNames[targetMonth]}`);
                    financeData[currentYear][targetMonth][currentCategory].push(newItem);
                });
            });
            
            closeCopyModal();
            alert(`NEW SYSTEM: Successfully copied ${selectedItems.length} items with EMPTY dates for user selection!`);
            
            renderCalendar();
            updateSummary();
            updatePieChart();
            
            // Auto-save after copying
            autoSave();
        }

        // Calculate monthly amount based on frequency
        function calculateMonthlyAmount(item, year, month) {
            // Only include amounts if the transaction date is in the current month
            const itemDate = new Date(item.date);
            const itemMonth = itemDate.getMonth();
            const itemYear = itemDate.getFullYear();
            
            // For one-off payments, only include if date matches current month/year
            if (item.frequency === 'one-off') {
                if (itemYear === year && itemMonth === month) {
                    return item.amount;
                }
                return 0;
            }
            
            // For recurring payments, check if they occur in this month
            const startDate = new Date(item.date);
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);
            
            if (startDate > monthEnd) {
                return 0;
            }
            
            let occurrences = 0;
            let currentDate = new Date(Math.max(startDate.getTime(), monthStart.getTime()));
            
            switch (item.frequency) {
                case 'weekly':
                    while (currentDate <= monthEnd) {
                        if (currentDate >= monthStart) {
                            occurrences++;
                        }
                        currentDate.setDate(currentDate.getDate() + 7);
                    }
                    break;
                    
                case 'fortnightly':
                    while (currentDate <= monthEnd) {
                        if (currentDate >= monthStart) {
                            occurrences++;
                        }
                        currentDate.setDate(currentDate.getDate() + 14);
                    }
                    break;
                    
                case 'twice-monthly':
                    // Always occurs twice per month if the start date is in or before this month
                    if (startDate <= monthEnd) {
                        // First occurrence: on the start date (if in current month)
                        if (startDate >= monthStart && startDate <= monthEnd) {
                            occurrences++;
                            console.log('First occurrence added for', item.description);
                        }
                        
                        // Second occurrence: always add one more if we're in the right month
                        // This represents the second payment in the month
                        if (startDate.getFullYear() <= year && 
                            (startDate.getFullYear() < year || startDate.getMonth() <= month)) {
                            occurrences++;
                            console.log('Second occurrence added for', item.description);
                        }
                    }
                    console.log('Twice-monthly calculation:', item.description, 'occurrences:', occurrences, 'amount:', item.amount, 'total:', item.amount * occurrences);
                    break;
                    
                case 'monthly':
                    if (startDate <= monthEnd && startDate.getDate() <= monthEnd.getDate()) {
                        occurrences = 1;
                    }
                    break;
                    
                case 'annually':
                    if (startDate.getMonth() === month && startDate.getFullYear() <= year) {
                        occurrences = 1;
                    }
                    break;
            }
            
            return item.amount * occurrences;
        }

        // Initialize data structure
        function initializeData() {
            for (let year = 2025; year <= 2030; year++) {
                financeData[year] = {};
                for (let month = 0; month < 12; month++) {
                    financeData[year][month] = {
                        income: [],
                        savings: [],
                        discretionary: [],
                        investments: [],
                        expenses: []
                    };
                }
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking Firebase auth state...');
            
            // Check authentication state
            auth.onAuthStateChanged(function(user) {
                console.log('Auth state changed. User:', user);
                
                if (user) {
                    console.log('User is authenticated:', user.email);
                    // User is signed in, proceed with app initialization
                    initializeApp();
                } else {
                    console.log('No user found - should redirect to login');
                    console.log('Redirecting to login-v6.html in 2 seconds...');
                    
                    // Add a small delay to see the logs, then redirect
                    setTimeout(() => {
                        console.log('Executing redirect now...');
                        window.location.href = './index.html';
                    }, 2000);
                }
            });
        });

        function initializeApp() {
            console.log('Initializing finance tracker...');
            
            // Update user info display
            const currentUser = auth.currentUser;
            if (currentUser) {
                document.getElementById('userInfo').textContent = `Welcome back, ${currentUser.email}`;
            }
            
            // UPDATED: Load data from Firebase first, then initialize UI
            loadDataFromFirebase().then(() => {
                setupEventListeners();
                updateCategoryDisplay();
                renderLineItems();
                renderCalendar();
                updateSummary();
                updatePieChart();
                generateInsights();
            });
        }

        function setupEventListeners() {
            // Year tabs
            document.querySelectorAll('.year-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.year-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentYear = parseInt(this.dataset.year);
                    document.getElementById('currentYear').textContent = currentYear;
                    document.getElementById('calendarYear').textContent = currentYear;
                    updateDisplay();
                });
            });

            // Month tabs
            document.querySelectorAll('.month-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentMonth = parseInt(this.dataset.month);
                    document.getElementById('calendarMonth').textContent = monthNames[currentMonth];
                    updateDisplay();
                });
            });

            // Category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    updateCategoryDisplay();
                    renderLineItems();
                });
            });
        }

        function updateDisplay() {
            renderLineItems();
            renderCalendar();
            updateSummary();
            updatePieChart();
            generateInsights();
        }

        function updateCategoryDisplay() {
            const config = categoryConfig[currentCategory];
            
            // Update text content
            document.getElementById('categoryTitle').textContent = config.title;
            document.getElementById('categoryDescription').textContent = config.description;
            document.getElementById('categoryName').textContent = config.title;
            
            // Update icon with emoji
            const iconElement = document.getElementById('categoryIcon');
            iconElement.innerHTML = config.emoji;
            iconElement.className = `category-icon ${currentCategory}`;
        }

        // UPDATED: Add auto-save to addLineItem
        function addLineItem() {
            const newItem = {
                id: Date.now(),
                description: '',
                amount: 0,
                date: '', // Empty date - user must select
                frequency: 'one-off',
                selected: false
            };
            financeData[currentYear][currentMonth][currentCategory].push(newItem);
            console.log('Added new item with empty date:', newItem); // Debug log
            renderLineItems();
            renderCalendar();
            updateSummary();
            updatePieChart();
            generateInsights();
            
            // Auto-save after adding item
            autoSave();
        }

        // UPDATED: Add auto-save to deleteLineItem
        function deleteLineItem(id) {
            financeData[currentYear][currentMonth][currentCategory] = 
                financeData[currentYear][currentMonth][currentCategory].filter(item => item.id !== id);
            renderLineItems();
            renderCalendar();
            updateSummary();
            updatePieChart();
            generateInsights();
            
            // Auto-save after deleting item
            autoSave();
        }

        // UPDATED: Add auto-save to updateLineItem
        function updateLineItem(id, field, value) {
            const item = financeData[currentYear][currentMonth][currentCategory].find(item => item.id === id);
            if (item) {
                if (field === 'amount') {
                    item[field] = parseFloat(value) || 0;
                } else {
                    item[field] = value;
                }
                console.log('Updated item:', item); // Debug log
                renderCalendar();
                updateSummary();
                updatePieChart();
                generateInsights();
                
                // Auto-save after updating item
                autoSave();
            }
        }

        function renderLineItems() {
            const container = document.getElementById('lineItemsContainer');
            const items = financeData[currentYear][currentMonth][currentCategory];
            
            console.log('Rendering items for', monthNames[currentMonth], 'in category', currentCategory, ':', items); // Debug log
            
            if (items.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6c757d;">No items added yet. Click "Add ' + categoryConfig[currentCategory].title + '" to get started.</div>';
                return;
            }
            
            container.innerHTML = items.map(item => {
                console.log('Rendering item:', item.description, 'with date:', item.date); // Debug log
                return `<div class="line-item">
                    <input type="checkbox" ${item.selected ? 'checked' : ''} 
                           onchange="updateLineItem(${item.id}, 'selected', this.checked)">
                    <input type="text" placeholder="Description" value="${item.description}" 
                           onchange="updateLineItem(${item.id}, 'description', this.value)">
                    <input type="number" placeholder="Amount ($)" value="${item.amount}" step="0.01"
                           onchange="updateLineItem(${item.id}, 'amount', parseFloat(this.value) || 0)">
                    <input type="date" value="${item.date || ''}" 
                           onchange="updateLineItem(${item.id}, 'date', this.value)"
                           placeholder="Select date">
                    <select onchange="updateLineItem(${item.id}, 'frequency', this.value)">
                        <option value="one-off" ${item.frequency === 'one-off' ? 'selected' : ''}>One-off</option>
                        <option value="weekly" ${item.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                        <option value="fortnightly" ${item.frequency === 'fortnightly' ? 'selected' : ''}>Fortnightly</option>
                        <option value="twice-monthly" ${item.frequency === 'twice-monthly' ? 'selected' : ''}>Twice Monthly</option>
                        <option value="monthly" ${item.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                        <option value="annually" ${item.frequency === 'annually' ? 'selected' : ''}>Annually</option>
                    </select>
                    <button class="btn btn-danger" onclick="deleteLineItem(${item.id})">
                        ✕
                    </button>
                </div>`;
            }).join('');
        }

        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const year = currentYear;
            const month = currentMonth;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            
            let calendarHTML = '';
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="calendar-day"></div>';
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dots = getDotsForDate(dateStr);
                const hasEvents = dots.length > 0;
                
                calendarHTML += `
                    <div class="calendar-day ${hasEvents ? 'has-events' : ''}" data-date="${dateStr}">
                        ${day}
                        ${dots.length > 0 ? '<div class="calendar-dots">' + dots.join('') + '</div>' : ''}
                    </div>
                `;
            }
            
            calendar.innerHTML = calendarHTML;
            
            // Add hover effects
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.addEventListener('mouseenter', showTooltip);
                day.addEventListener('mouseleave', hideTooltip);
            });
        }

        function getDotsForDate(dateStr) {
            let dots = [];
            Object.keys(categoryConfig).forEach(category => {
                const items = financeData[currentYear][currentMonth][category];
                const hasItem = items.some(item => {
                    // Check if item has data and description
                    if (!item.description || !item.amount || item.amount <= 0) return false;
                    
                    if (item.date === dateStr) return true;
                    if (item.frequency !== 'one-off') {
                        return isRecurringDate(item.date, item.frequency, dateStr);
                    }
                    return false;
                });
                
                if (hasItem) {
                    dots.push(`<div class="calendar-dot dot-${category}"></div>`);
                }
            });
            console.log('Dots for', dateStr, ':', dots); // Debug log
            return dots;
        }

        function isRecurringDate(startDate, frequency, checkDate) {
            const start = new Date(startDate);
            const check = new Date(checkDate);
            
            if (check < start) return false;
            
            const diffTime = check.getTime() - start.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            switch (frequency) {
                case 'weekly':
                    return diffDays % 7 === 0;
                case 'fortnightly':
                    return diffDays % 14 === 0;
                case 'twice-monthly':
                    const startDay = start.getDate();
                    const checkDay = check.getDate();
                    const secondDate = startDay + 15;
                    const monthEnd = new Date(check.getFullYear(), check.getMonth() + 1, 0).getDate();
                    const adjustedSecondDate = secondDate > monthEnd ? monthEnd : secondDate;
                    
                    return (checkDay === startDay || checkDay === adjustedSecondDate) && 
                           check.getMonth() >= start.getMonth() && 
                           check.getFullYear() >= start.getFullYear();
                case 'monthly':
                    return start.getDate() === check.getDate() && 
                           check >= start;
                case 'annually':
                    return start.getDate() === check.getDate() && 
                           start.getMonth() === check.getMonth() && 
                           check.getFullYear() >= start.getFullYear();
                default:
                    return false;
            }
        }

        function showTooltip(event) {
            const dateStr = event.target.dataset.date;
            if (!dateStr) return;
            
            const tooltip = document.getElementById('tooltip');
            let content = '';
            
            Object.keys(categoryConfig).forEach(category => {
                const items = financeData[currentYear][currentMonth][category];
                items.forEach(item => {
                    // Only show items with description and amount
                    if (!item.description || !item.amount || item.amount <= 0) return;
                    
                    let showItem = false;
                    if (item.date === dateStr) {
                        showItem = true;
                    } else if (item.frequency !== 'one-off' && isRecurringDate(item.date, item.frequency, dateStr)) {
                        showItem = true;
                    }
                    
                    if (showItem) {
                        const frequencyText = item.frequency !== 'one-off' ? ` (${item.frequency})` : '';
                        content += `<strong>${item.description}</strong>: ${item.amount.toFixed(2)}${frequencyText}<br><em>${categoryConfig[category].title}</em><br><br>`;
                    }
                });
            });
            
            if (content) {
                tooltip.innerHTML = content;
                tooltip.style.display = 'block';
                tooltip.style.left = event.pageX + 10 + 'px';
                tooltip.style.top = event.pageY + 10 + 'px';
            }
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function updateSummary() {
            const totals = {
                income: 0,
                savings: 0,
                discretionary: 0,
                investments: 0,
                expenses: 0
            };
            
            Object.keys(totals).forEach(category => {
                const items = financeData[currentYear][currentMonth][category];
                items.forEach(item => {
                    const monthlyAmount = calculateMonthlyAmount(item, currentYear, currentMonth);
                    totals[category] += monthlyAmount;
                    if (item.frequency === 'twice-monthly' && monthlyAmount > 0) {
                        console.log('Twice-monthly item:', item.description, 'monthly amount:', monthlyAmount);
                    }
                });
                console.log(`${category} total:`, totals[category]);
            });
            
            document.getElementById('totalIncome').textContent = `${totals.income.toFixed(2)}`;
            document.getElementById('totalSavings').textContent = `${totals.savings.toFixed(2)}`;
            document.getElementById('totalDiscretionary').textContent = `${totals.discretionary.toFixed(2)}`;
            document.getElementById('totalInvestments').textContent = `${totals.investments.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `${totals.expenses.toFixed(2)}`;
        }

        function updatePieChart() {
            const ctx = document.getElementById('pieChart').getContext('2d');
            
            const totals = {
                income: 0,
                savings: 0,
                discretionary: 0,
                investments: 0,
                expenses: 0
            };
            
            Object.keys(totals).forEach(category => {
                const items = financeData[currentYear][currentMonth][category];
                items.forEach(item => {
                    totals[category] += Math.abs(calculateMonthlyAmount(item, currentYear, currentMonth));
                });
            });
            
            if (pieChart) {
                pieChart.destroy();
            }
            
            const totalAmount = Object.values(totals).reduce((sum, val) => sum + val, 0);
            
            if (totalAmount > 0) {
                pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Income', 'Savings', 'Discretionary', 'Investments', 'Expenses'],
                        datasets: [{
                            data: [totals.income, totals.savings, totals.discretionary, totals.investments, totals.expenses],
                            backgroundColor: [
                                categoryConfig.income.color,
                                categoryConfig.savings.color,
                                categoryConfig.discretionary.color,
                                categoryConfig.investments.color,
                                categoryConfig.expenses.color
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const percentage = ((value / totalAmount) * 100).toFixed(1);
                                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px -apple-system, BlinkMacSystemFont, Segoe UI, Roboto';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'center';
                ctx.fillText('Monthly Budget Breakdown (AUD)', ctx.canvas.width/2, ctx.canvas.height/2 - 20);
                ctx.fillText('No data to display', ctx.canvas.width/2, ctx.canvas.height/2 + 10);
            }
        }

        function generateInsights() {
            const totals = {
                income: 0,
                savings: 0,
                discretionary: 0,
                investments: 0,
                expenses: 0
            };
            
            Object.keys(totals).forEach(category => {
                const items = financeData[currentYear][currentMonth][category];
                items.forEach(item => {
                    totals[category] += calculateMonthlyAmount(item, currentYear, currentMonth);
                });
            });
            
            const totalIncome = totals.income;
            const totalExpenses = totals.expenses + totals.discretionary;
            const totalSavings = totals.savings + totals.investments;
            
            let insights = [];
            
            if (totalIncome > 0) {
                const savingsRate = (totalSavings / totalIncome) * 100;
                const expenseRatio = (totalExpenses / totalIncome) * 100;
                
                if (savingsRate >= 20) {
                    insights.push(`<strong>Excellent Savings Rate!</strong><br>You're saving ${savingsRate.toFixed(1)}% of your income this month. This puts you well above the recommended 20% savings rate.`);
                } else if (savingsRate >= 10) {
                    insights.push(`<strong>Good Savings Progress</strong><br>You're saving ${savingsRate.toFixed(1)}% of your income this month. Consider increasing to 20% if possible for optimal financial health.`);
                } else if (savingsRate > 0) {
                    insights.push(`<strong>Building Savings Habit</strong><br>Currently saving ${savingsRate.toFixed(1)}% of income this month. Aim to gradually increase towards 10-20% for better financial security.`);
                } else {
                    insights.push(`<strong>Focus on Savings</strong><br>Consider allocating a portion of your income to savings. Even 5-10% can make a significant difference over time.`);
                }
                
                if (expenseRatio > 80) {
                    insights.push(`<strong>Review Expenses</strong><br>Your expenses represent ${expenseRatio.toFixed(1)}% of income this month. Look for opportunities to reduce non-essential spending.`);
                }
                
                if (totals.investments > 0) {
                    insights.push(`<strong>Investment Activity</strong><br>Great to see you're investing ${totals.investments.toFixed(2)} this month. Keep building your future wealth through regular investments.`);
                }
                
                const netPosition = totalIncome - totalExpenses;
                if (netPosition > 0) {
                    insights.push(`<strong>Positive Cash Flow</strong><br>You have ${netPosition.toFixed(2)} left after expenses this month. Consider directing this towards savings or investments.`);
                }
            }
            
            if (insights.length === 0) {
                insights.push('<strong>Savings Analysis</strong><br>Add income, expenses, and savings to see insights about your savings potential.');
            }
            
            document.getElementById('insightsContent').innerHTML = insights.map(insight => 
                `<div class="insight-item">${insight}</div>`
            ).join('');
        }

        function showCopyModal() {
            const selectedItems = financeData[currentYear][currentMonth][currentCategory].filter(item => item.selected);
            if (selectedItems.length === 0) {
                alert('Please select items to copy first by checking the boxes next to them.');
                return;
            }
            
            const modal = document.getElementById('copyModal');
            const checkboxContainer = document.getElementById('monthCheckboxes');
            
            checkboxContainer.innerHTML = monthNames.map((month, index) => 
                `<label class="month-checkbox">
                    <input type="checkbox" value="${index}"> ${month} ${currentYear}
                </label>`
            ).join('');
            
            modal.style.display = 'block';
        }

        function closeCopyModal() {
            document.getElementById('copyModal').style.display = 'none';
        }

        function executeCopy() {
            console.log('executeCopy function called'); // Debug log
            
            const selectedItems = financeData[currentYear][currentMonth][currentCategory].filter(item => item.selected);
            console.log('Selected items:', selectedItems); // Debug log
            
            const selectedMonths = Array.from(document.querySelectorAll('#monthCheckboxes input:checked')).map(cb => parseInt(cb.value));
            console.log('Selected months:', selectedMonths); // Debug log
            
            if (selectedMonths.length === 0) {
                alert('Please select at least one month to copy to.');
                return;
            }
            
            selectedMonths.forEach(monthIndex => {
                console.log(`Processing month index: ${monthIndex}`); // Debug log
                
                selectedItems.forEach(item => {
                    // Create new item with updated date for target month
                    const originalDate = new Date(item.date);
                    const originalDay = originalDate.getDate();
                    
                    // Create new date in target month, keeping the same day
                    const newDate = new Date(currentYear, monthIndex, originalDay);
                    
                    // If the day doesn't exist in target month (e.g., Jan 31 → Feb), use last day of month
                    if (newDate.getMonth() !== monthIndex) {
                        newDate.setDate(0); // Sets to last day of previous month
                    }
                    
                    const newItem = { 
                        ...item, 
                        id: Date.now() + Math.random(), 
                        selected: false,
                        date: newDate.toISOString().split('T')[0] // Update date to target month
                    };
                    
                    console.log(`Copying item "${item.description}" from ${item.date} to ${newItem.date}`); // Debug log
                    
                    financeData[currentYear][monthIndex][currentCategory].push(newItem);
                });
            });
            
            closeCopyModal();
            alert(`Successfully copied ${selectedItems.length} items to ${selectedMonths.length} months with updated dates.`);
            
            // Refresh display to show updated calendar/summary
            renderCalendar();
            updateSummary();
            updatePieChart();
            
            // Auto-save after copying
            autoSave();
        }

        function saveProgress() {
            // Store data in variables (since localStorage is not available)
            const dataToSave = JSON.stringify(financeData);
            alert('Progress saved to memory! (Note: Data will be lost when you refresh the page since browser storage is not available in this environment)');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('copyModal');
            if (event.target === modal) {
                closeCopyModal();
            }
        }
    </script>
</body>
</html>
